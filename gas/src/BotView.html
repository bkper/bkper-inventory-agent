<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <!-- Include Style.html file -->
  <?!= include('BotViewStyle'); ?>
</head>

<body>

  <div class='header'>
    Cost of goods sold for&nbsp;<strong>
      <?!= book.name ?>
    </strong>
  </div>

  <div class='body'>
    <div class='sub-header'>
      Calculate using FIFO method
    </div>
  </div>

  <div class="footer" id='footer-panel'>
    <button id="calculate-button" onclick="calculate()">Calculate</button>
    <button id="close-button" onclick="closeWindow()">Close</button>
  </div>

</body>

</html>

<script>

  async function calculate() {
    disableButtons(true);
    google.script.run
      .withSuccessHandler(async () => {
        await fireCalculateForAll().catch(showError);
        disableButtons(false);
      })
      .withFailureHandler((error) => {
        showError(error);
        disableButtons(false);
      })
      .validate('<?!= book.id ?>')
      ;
  }

  function fireCalculateForAll() {
    google.script.run.withSuccessHandler(disableButtons(false)).withFailureHandler(showError).calculateCostOfSales('<?!= book.id ?>', '<?!= account.id ?>');
  }

  function showError(error) {
    window.alert(error);
  }

  function disableButtons(disable) {
    if (disable) {
      document.getElementById('calculate-button').setAttribute('disabled', true);
      document.getElementById('close-button').setAttribute('disabled', true);
    } else {
      document.getElementById('calculate-button').removeAttribute('disabled');
      document.getElementById('close-button').removeAttribute('disabled');
    }
  }

  function closeWindow() {
    try {
      window.top.close();
    } catch (error) {
      console.log("Attempt to automatically close window failed: " + error);
      showError(error);
    }
  }

</script>